<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>PubRTC + Mobile</title>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" type="text/css" href="https://dva-studio.github.io/tod/stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.3.0/css/font-awesome.min.css" />
    <script src="https://dva-studio.github.io/tod/js/modernizr.custom.js"></script>
	<link rel="stylesheet" type="text/css" href="https://dva-studio.github.io/tod/stylesheets/normalize.css" />
    <style>
        .videoContainer 
        {
            position:absolute;
            height:100%;
            width:100%;
            overflow: hidden;
}
        video 
        {
            min-width: 100%;
            min-height: 100%;
            transform: translate(0%, -0%);
        }
    </style>

    
</head>
<body>
    <!--
        Debug buttons:
        <button onclick="begin('alice')">Begin as Alice</button>
        <button onclick="begin('bob')">Begin as Bob</button>
        <button onclick="call('alice')">Call Alice</button>
        <button onclick="call('bob')">Call Bob</button>
    -->
    
    <div class="videoContainer">
        <video id="remoteVideo" autoplay></video>
    </div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub.min.js"></script>
<script src="https://dva-studio.github.io/tod/js/classie.js"></script>
<script src="https://dva-studio.github.io/tod/js/webrtc.js"></script>

<script type="text/javascript">
    
    var videoOffsetX = 0;
    var videoOffsetY = 0;
    
    
    // Get reference to video element
    var videoWindow = document.getElementById("remoteVideo");
    
    // Get user parameter
    var user = new URL(window.location).searchParams.get("device");
    
    // Begin session using user name
    begin(user);
    
    
    document.addEventListener('keydown', (event) => {
        const keyName = event.key;
        if (keyName == "ArrowUp")
        {
            videoOffsetY++;
        }
        if (keyName == "ArrowDown")
        {
            if (videoOffsetY > 0)
                videoOffsetY--;
        }
        if (keyName == "ArrowLeft")
        {
            if (videoOffsetX > 0)
            videoOffsetX--;
        }
        if (keyName == "ArrowRight")
        {
            videoOffsetX++;
        }
        
        videoWindow.style.transform = "translate(0%, -" + videoOffsetY + "%)";
    }, false);

    
    
    function go ()
    {
        if (user == 'bob')
            call('alice');
        
        if (user == 'alice')
            call('bob');
    }
    
    function begin (n)
    {
        var phone = window.phone = PHONE({
            number        : n || "Anonymous", // listen on username line else Anonymous
            media         : { video: { width: 1920, height: 1080 } },
            publish_key   : 'pub-c-229d2ef7-d6fb-4387-80e9-3b142c8be097', // Your Pub Key
            subscribe_key : 'sub-c-3c7c1fc8-5052-11e8-9796-063929a21258', // Your Sub Key,
            ssl: true
        });	    
	
        // Phone has been initialized
        phone.ready(function() { 
            // When local stream up and running, show local stream
            videoWindow.srcObject = phone.mystream;
            if (user == 'bob')
            {
                call('alice');
            }
        });
        
        phone.callstatus(function(foo) {
           //alert("call status: " + foo.status); 
        });
        
        phone.unable(function(foo) {
            //alert("unable " + foo);
        });
        
        phone.disconnect(function() {
           //alert("disconnected"); 
        });
    
        // When a phone call is being received
        phone.receive(function(session) {
            // And we are connected
            session.connected(function(session)
            {
                // Set incoming video to the video window
                videoWindow.srcObject = session.video.srcObject;
            });
            session.ended(function(session) 
            { 
                videoWindow.srcObject = phone.mystream;
            });
	   });    
        if (n == "bob")
        {
            
        }
    }
	
    
    function call (n)
    {
        phone.dial(n);
    }
    
    
    function makeCall(form){
        if (!window.phone) alert("Login First!");
        else phone.dial(form.number.value);
        return false;
    }

    function showModal(){
        $("#showModal").click();
    }

    function errWrap(fxn, form){
        try {
            return fxn(form);
        } catch(err) {
            alert("WebRTC is currently only supported by Chrome, Opera, and Firefox");
            return false;
        }
    }
</script>
</html>